# qETRC列车运行图系统

## 概要

本软件是原pyETRC列车运行图系统的C++重构版本，主要支持列车运行图的绘制、管理、分析等功能。原pyETRC软件原则上不再进行维护。

- 作者：萧迩珀；联系方式：mxy0268@qq.com

- 本系统官方交流群（与pyETRC一致）：865211882

- 本项目开源库：

  - https://github.com/CDK6182CHR/qETRC 
  - https://gitee.com/xep0268/qETRC/

  原则上两边同步更新。

- 原pyETRC系统开源地址：https://github.com/CDK6182CHR/train_graph。

**声明**：

- 本系统按照GPL协议开放源代码。在法律和协议允许范围内，作者保留一切权利。

#### 致谢

- “LGuo的电子运行图”软件（`ETRC`）。本软件最初的开发工作由此而起，并参考该软件较多功能。本软件支持读取和导出其运行图文件。

- [Advanced-Docking-System](https://github.com/githubuser0xFFFF/Qt-Advanced-Docking-System)：提供了任意组织停靠面板的功能。
- [SARibbon](https://github.com/czyt1988/SARibbon): 提供了Ribbon风格工具栏的功能。

## 运行说明

作者提供Win64构建的二进制版本，可以直接运行；也可以从开源库拉取源代码，自行构建。

因Qt 6不再支持windows 7，自V1.4.0 (R42) 版本起，win64发行版不能在windows 7及以下版本的操作系统中运行。

- win64发行版目前采用MSVC编译器构建，可能需要MSVC的运行时库。
- 源代码构建提示：至少需要Qt5 （小版本号的要求暂不确定，开发用的是5.15），支持C++17标准的编译器。建议采用MSVC 2019。自发行版V1.4.0起，开发采用的Qt版本升级到Qt 6.5.1。

## 文档与教程

- 在线文档（持续编辑中）：https://qetrc.readthedocs.io/
- 新手指引（视频）：https://www.bilibili.com/video/BV1FM411V7cr
- 相关视频合集：https://space.bilibili.com/179545382/channel/collectiondetail?sid=350082

## 版本更新日志

### 2024年3月20日  发布1.6.3版本 (R52)

更新日志 (1.6.2->1.6.3)

本次更新主要修复一些问题和细节：

1. 修复列车径路包含不存在的车次的极端情况下，打开运行图时程序崩溃的问题。
2. 修复删除所有车次操作时，列车径路中车次状态没有更新的问题。
3. 在使用列车径路铺画运行线时，不再允许单车站的运行线。
4. 修复一些内存泄漏问题。

### 2024年3月19日  发布1.6.2版本 (R51)

更新日志 (1.6.1->1.6.2)

修复刷新运行图后，拖动时刻可能导致程序崩溃的问题。

### 2024年3月17日  发布1.6.1版本 (R50)

更新日志 (1.6.0->1.6.1)

1. 在列车的批量操作中，新增“自动设置所有列车运行线样式”以及“自动设置列车运行线样式”功能，分别位于工具栏`列车 (3)`页面以及`列车管理`停靠面饭，且分别用于全部车次和所选择的部分车次。
2. 修复：存在单向站时，导出ETRC列车运行图文件可能造成闪退的问题。

### 2024年3月2日 发布1.6.0版本 (R49)

更新日志 (1.5.5->1.6.0)

本次更新主要优化与交路连线、车次标注相关的功能，增加相关的选项，提供新的标注模式。

此版本更新较大，提醒用户及时做好数据保存和备份。如有问题，可将有关运行图和遇到的问题、相应的操作发送到作者邮箱。

1. 【重要调整】本次更新修改了运行线铺画的实现方式。与此前版本相比，在相同设置下，运行线线宽会减小。如果习惯以前的线宽，可以在类型管理器中调整各类型的运行线宽度。
2. 【新特性】新增浮动交路连线功能，默认开启。启用时，交路连线不再与车站水平线重合，而是拉开一定高度（高度由用户指定），遇到有相互重叠的交路连线时自动分层以避免重叠。新增交路连线显示选项，可选择显示、不显示或者仅选中车次显示。
3. 【新特性】新增可选的在交路连线上标注后续车次或交路名功能，默认关。同时新增交路连线、标签颜色可选，可选择使用车次运行线颜色或运行图文字颜色。
4. 【新特性】新增“车次标注形式”设置项。原有标注形式为“标签模式”，此版本新增“交路连线模式”。该模式中，对于（在交路中）有前序车次的车次，取消运行线起始点标签，而将车次标注在交路连线终点处。在此种设置下，“基准/层级标签高度”设置项无效，所有起止标签、交路连线高度由“基准/层级连线高度”控制。同时新增“隐藏有连线终止标签”等相关设置，并提供推荐设置及其一键引入。
5. 在交路编辑中，新增对虚拟车次设置始发、终到站的支持。此处的始发、终到站设置仅供显示完整，无其他作用。
6. 调整运行图铺画逻辑。现在原则上允许任意设置运行图起始/结束时刻；时间范围不覆盖所有车次运行线也是良定义的。但后者仍是不推荐的，仍然可能有些极端情况导致出现问题。

### 2024年2月13日 发布1.5.5版本 (R48)

更新日志 (1.5.4->1.5.5)

1. 【新特性】在贪心推线中，支持固定指定车站停车时间，即强制该车站停车时间为设置值且不得延长。适用于无停车条件、需限制停车时间的车站。
2. 【新功能】在标尺排图、贪心推线中，新增“批量设置停点”功能，支持一次性为（一定等级以上的）所有（或所选）车站设置相同的停车时长。
3. 【新功能】在标尺排图、贪心推线中，新增点击正在铺画的运行线上的铺画点，弹出铺画设置面板，可在面板中设置停车时长、是否固定（仅限贪心推线）。同时，在排图状态下，总是默认高亮所排运行线。
4. 【新功能】新增标尺数据导出为CSV格式以及从相同格式导入。
5. 新增全局隐藏特定类型的运行线起止标签功能。
6. 修复特定情况下，列车种类重复的问题。

### 2024年1月4日 发布1.5.4版本 (R47)

更新日志 (1.5.3->1.5.4)

本次更新修复部分已知问题并优化部分细节，具体为：

1. 修复类型管理中，某些情况下默认类型重复的问题。
2. 在车次编辑页面中，支持全车次输入后TAB键自动生成分方向车次。

### 2023年12月21日 发布1.5.3版本 (R46)

更新日志 (1.5.2->1.5.3)

本次更新将支持库SARibbon版本更新至1.0.7版本，并修复部分问题。具体如下：

1. 升级SARibbon支持库至1.0.7版本，解决Github issue #3。
2. 修复Github issue #2，即空白运行图下点击基线编辑等功能导致程序崩溃问题。
3. 修复贪心推线功能中，非起点的锚点站有停点导致的时刻计算错误问题。
4. 修复空白线路数据库造成的问题。

此版本如需使用补丁包升级，请将`SARibbonBar.dll`文件随`qETRC.exe`文件一并复制。

### 2023年9月30日 发布1.5.2版本 (R45)

更新日志 (1.5.1->1.5.2)

主要修复部分场景下的问题，具体为：

1. 批量复制车次功能中，没有检查输入的车次是否重复的问题。
2. 部分情况下，选中含有交路的列车导致程序闪退的问题。
3. 导入使用标尺排图的线路时，纵坐标设置错误的问题。

### 2023年9月12日 发布1.5.1版本 (R44)

更新日志 (1.5.0->1.5.1)

1. 在列车管理的列表中，新增“技术速度”显示。
2. 修复：列车始发/终到站存在多个铺画点的情况下，交路连线可能错误的问题。
3. 修复：有列车径路情况下，撤销/重做删除线路操作，可能导致运行线异常的问题。

### 2023年8月28日 发布1.5.0版本 (R43)

更新日志 (1.4.0->1.5.0)

此版本主要是添加了**列车径路** (`TrainPath`) 数据项，并添加相应的增删编辑、与列车关联以及按列车径路铺画运行线等功能。关于列车径路的部分概念（暂定）简要说明如下。

- 列车径路是一段**单向**、**连续**的线路（`Railway`）片段（segment）的组合，用于描述列车在线路上的运行路线。
- 可以指定任意数量的列车（`Train`）到列车径路。被指定到列车径路的列车，在铺画其运行线时，按照列车径路所示的线路铺画，而不采用默认的自动铺画算法。此种情况下，“最大跨越站数”设置项对该列车无效。
- 列车径路记载一组线路和线路上的车站**站名**信息。如果相关线路被删除，或者相关车站被删除或者更名，列车径路可能进入**不可用**状态。不可用状态的列车径路，在运行线铺画中将被忽略。
- 原则上，指定到列车径路的列车，应当是严格按照径路（或者其中连续的某一段）运行的。若列车时刻表上有车站不在所指定的列车径路范围内，则该车站将被忽略，即使它属于本运行图中的某一线路。
- 按径路铺画运行线时，列车径路上的每一段（segment）对应一段列车运行线（`TrainLine`）。如果列车径路上有连续两个段（segment）属于同一线路、同一方向，则两段会分别设置两段独立的运行线。
- 虽然同一列车可以指定多个列车径路，但这不是推荐的做法。多个列车径路之间的运行线分析是**完全独立**的。特别是，如果多段运行线之间存在交集，将导致同一区间出现重复的列车运行线。

以上为暂定的规定。在后续新版本中，可能还会继续更新。由于此版本改动较大，可能存在较多问题，请注意及时保存和备份数据。欢迎反馈问题和建议。

除此之外，还有以下更新。

1. 新增`输出`和`问题`两个停靠面板，默认为自动隐藏面板，位于窗口底端。分别显示运行过程中的一些文本输出和运行线铺画过程中的问题。
2. 在标尺排图功能中，若选择新排的运行线追加到既有列车或者修改既有时刻表，新增推断所属线路的逻辑。

### 2023年6月26日 发布1.4.0版本 (R42)

更新日志 (1.3.7->1.4.0)

此版本不支持使用补丁包升级，请使用完整版，或者将完整包中的**所有**`*.dll`文件和`qETRC.exe`文件一并替换到原程序所在目录（原目录中所有`*.dll`文件皆可删除或覆盖）。

1. 更新Qt库版本为Qt 6.5.1，调整部分尺寸设置。
2. 重新设计运行图纵线的设置系统，允许手动规定三个层次纵线的间隔。
3. 新增列车类型设置、列车类型规则设置在当前运行图设置、系统默认设置间应用的功能。
4. 新增显示设置、类型管理系统的“透明模式”，详见[在线文档](https://qetrc.readthedocs.io/zh_CN/latest/view/view.html#sec-transparent-config)。
5. 修正一些细节问题。

### 2023年6月16日 发布1.3.7版本 (R41)

更新日志 (1.3.6->1.3.7)

1. 修订列车间隔分析系统，支持同一车站相对两侧（站前/站后）之间的事件产生间隔，即允许“不同时到达间隔”、“不同时出发间隔”等类型。
2. 修改程序构建系统为CMake。
3. 升级第三方库SARibbon和ads至最新版。同时首页右侧停靠面板默认设为自动隐藏（ads新功能）。

### 2023年6月6日 发布1.3.6版本 (R40)

更新日志 (1.3.5->1.3.6)

1. 优化拖动调整运行线功能。新增铺画点突出显示（铺画点上的方块），选中车次时自动显示，拖动铺画点即可调整时刻。
2. 修正停站期间跨日所导致的时间计算错误问题。
3. 将区间车次表功能中的相关提示弹窗改为程序运行期间仅显示一次。

### 2023年6月4日 发布1.3.5版本 (R39)

更新日志 (1.3.4->1.3.5)

1. 【新功能】添加拖动运行线调整时刻功能。对于通过车站，按住Ctrl拖动调整到达时刻，按住Alt拖动调整出发时刻，否则调整通过时刻（即到发同时调整）。
2. 在交路编辑页面中新增手动刷新。

### 2023年5月19日 发布1.3.4版本 (R38)

更新日志 (1.3.3->1.3.4)

调整交路图功能的判定条件，取消“交路中车次的始发/终到站必须有铺画点”的限制。

### 2023年2月18日 发布1.3.3版本 (R37)

更新日志 (1.3.2->1.3.3)

1. 调整优化`区间车次表`中超过24小时车次时间的计算问题，并调整时长排序。
2. 调整`速览信息`中显示的项目，添加全程时间、里程、速度等项目，在满足条件的情况下计算。
   近期将更新专栏文章，详细说明此中逻辑。

### 2023年2月4日 发布1.3.2版本 (R36)

更新日志 (1.3.1->1.3.2)

新增`快速推定`功能，用于一键推定所选列车在当前线路的通过站时刻。功能位于右键菜单和工具栏`列车编辑`上下文菜单中。此功能推定所得的时刻使得列车运行线形状基本不变，不考虑起停附加时分且不支持外插。对于更复杂的需求以及批量需求，请考虑使用`时刻插值`功能。



### 2023年1月27日 发布1.3.1版本 (R35)

更新日志 (1.3.0->1.3.1)

1. 在列车筛选器系统中，更新部分细节或修复部分问题，主要有：
   - 修复标尺综合功能中一处布局错误；
   - 显示列车筛选器前更新数据；
   - 列车筛选器管理页面中，自动选中新添加的筛选器，且禁止编辑空白筛选器。
2. 修正单双线判定的逻辑。

### 2023年1月24日 发布1.3.0版本 (R34)

更新日志 (1.2.6->1.3.0)

在此版本中，重新设计了列车筛选器功能，具体包括：

- 支持预置列车筛选器。可以在每个运行图文件中，设置一组列车筛选器，在需要使用筛选器的场景一键应用，或者从已有的预设出发修改。
- 重新设计列车筛选器对话框的界面，减少操作层级，并支持引入预设。
- 在大多数使用列车筛选器的入口界面，新增选择预设的下拉菜单，支持一键应用预设。

其他杂项更新：

- 【pyETRC既有功能升级适配】新增列车运行统计功能，位于工具栏页面`列车` | `运行统计`。对于选定的列车及区间，计算区间运行总时长等，在有数据支撑的情况下，也计算里程和速度。相比pyETRC，此功能考虑了多线路情况下的径路与里程计算问题。

- 新增在列车管理界面、运行图资源管理器界面选择列车后，自动高亮运行线功能，在全局配置选项中设置相应开关（默认开，即与pyETRC一致）。

- 重新整理标尺排图和贪心推线功能中，新生成时刻表的营业（办客或办货）站设置规则：

  - 仅在始发终到站或停车站中讨论是否营业，其他车站一律不营业；

  - 对于标尺排图功能，上述车站中，客车在办客车站营业，货车在办货车站营业，否则不营业。

    > 车站是否办客/办货的设置，在基线编辑中

  - 对于贪心推线功能，在用户指定的停车站营业，非用户指定、但由推线算法计算的停车站不营业。



### 2023年1月13日 发布1.2.6版本 (R33)

此版本更新了依赖库版本，如使用`patch`版，请将相关`dll`文件一并复制。

更新日志 (1.2.5->1.2.6)

1. 新增列车批量处理功能：

   - 删除列车时刻表中，未铺画的车站。

   - 删除无任何铺画站的列车。

   - 删除时刻表为空白的列车。

2. 修复线路里程表编辑的相关问题。

3. 优化保存运行图文件的体积。

上述功能见于工具栏`列车`面板，`批量操作`菜单下。



### 2022年12月29日 发布1.2.5版本 (R32)

更新日志 (1.2.4->1.2.5)

1. 【pyETRC既有功能移植】新增`线路拼接`功能，位于`线路`上下文页面中。支持将当前线路与**本运行图文件内**的其他线路合并。如果需要和其他文件内的线路合并，请先导入该线路。
2. 新增从速度计算标尺时，可选择应用的区段。
3. 新增从文件导入线路时，对于多线路的文件，可选择导入一部分线路。

### 2022年11月19日 发布1.2.4版本 (R31)

更新日志 (1.2.3->1.2.4)

1. 添加标尺排图/贪心推线中，新增导入既有车次停站时长的功能。
2. 在贪心推线中，新增筛选列车功能，只考虑通过筛选的车次。
3. 修复线路反排操作导致的错误。

### 2022年10月29日 发布1.2.3版本 (R30)

1. 在列车时刻表修正功能中新增局部严格排序功能。
2. 新增标尺编辑中批量设置起停附加时分。
3. 修复标尺排图提交空数据时崩溃的问题。

### 2022年10月14日 发布1.2.2版本 (R29)

更新日志 (1.2.1->1.2.2)

1. 在基线编辑中新增批量勾选/取消勾选/切换勾选的功能，见右键菜单。
2. 修复和优化与ETRC交互的功能。包括：
   - 修复上一版本中打开`*.trc`文件导致程序崩溃的问题。
   - 修复车站显示/隐藏选项读写错误问题。
   - 新增`*.trc`文件中读写单双线区间的信息。

### 2022年9月23日 发布1.2.1版本 (R28)

更新日志 (1.2.0->1.2.1)

修复逻辑漏洞：将车站的纵坐标参数（`y_coeff`）作为车站的有效属性之一，程序应全程维护此属性有效。此前版本由于不保证此属性有效，导致在线路没有铺画运行图时计算相关车次的事件表、时刻诊断等可能导致程序崩溃。

### 2022年9月12日 发布1.2.0版本 (R27)

更新日志 (1.1.12->1.2.0)

1. 【重要逻辑更新】新增单双线数据，数据的编辑位于基线编辑中。每行的复选框指定该站的**前序区间**（里程小端的区间）是否为单线。单线区间必须是对称的区间（即区间前后站都是双向通过站）。
2. 新增`线路拓扑`功能，显示当前线路的区间拓扑（topology）信息，包括单向站和单线区间，同时检查相关设置是否有问题。
3. 在`时刻诊断`功能中新增每个条目的里程标和时刻显示，并新增定位到运行图功能，使用右键菜单或者双击可以触发。
4. 新增打开运行图时（包括启动软件时）检查运行图中基线信息有无错误的功能。

### 2022年8月28日 发布1.1.12版本 (R26)

更新日志 (1.1.11->1.1.12)

1. 修复某些极端情况下，运行线铺画逻辑错误的问题。
2. 新增内置在线文档链接和启动提示页。

### 2022年8月12日 发布1.1.11版本 (R25)

更新日志 (1.1.10->1.1.11)

1. 修订时刻表中始发（终到）站的判定逻辑，强制要求仅当车站在时刻表第一站（最后一站）时，才判定是否为始发（终到）站。
2. 修正打开运行图文件时没有读取列车停站股道和营业信息的问题。
3. 修订列车时刻表中车站颜色显示问题。

### 2022年6月5日 发布1.1.10版本 (R24)

更新日志 (1.1.9->1.1.10)

1. 调整列车时刻表自动更正算法中的几个错误。
2. 修正贪心推线算法在多天窗同时启用情况下的一个错误。
3. 在线路信息发生非Topology等价的更新时，自动更新贪心推线窗口的相关信息，防止出现崩溃。同时新增`退出贪心排图状态`的用户操作接口，在相关功能出现异常时可以手动执行。
4. 在`运行图设置`窗口中新增`应用`按钮，执行更改但不关闭窗口。
5. 从此版本开始向运行图文件写入当前程序的版本名和发行代码，打开运行图时自动检查，如果文件中记录的版本比当前软件版本更新，则提示信息。

### 2022年5月29日 发布1.1.9版本 (R23)

更新日志 (1.1.8->1.1.9)

1. 新增自动更正列车时刻表功能，针对单车次的操作位于`时刻修正`中，且同时增加批量操作。请注意此功能未经充分测试，不一定能解决问题，且可能出现错误，请注意做好数据保存和备份。
   如果关于此功能出现问题，请使用邮件反馈。
2. 新增批量（或全部）导出CSV时刻表功能。
3. 新增拖入运行图文件打开功能。因未知原因，目前拖入运行图窗口无法识别，请拖入程序的其他部分/窗口。

### 2022年5月22日 发布1.1.8版本 (R22)

更新日志 (1.1.7->1.1.8)

1. 在 `运行图(5)` 上下文工具栏页面中新增 (水平|垂直)(放大|缩小) 快捷操作按钮，更改当前运行图显示比例。此操作支持撤销，且连续操作自动合并（连续的变更一次性撤销）。
2. 在贪心推线功能的算法运行记录中新增递归进入/退出的记录。
3. 修改部分小问题：
   - 修订间隔分组错误问题：`待避`类型不算入追踪/间隔组间隔。
   - 修正出现折返运行线的情况下，部分场景停点没有显示的问题。
   - 修正时刻诊断报告的一处格式化错误的问题。
   - 修改某些极端情况下的运行图铺画算法。

### 2022年5月14日 发布1.1.7版本 (R21)

更新日志 (1.1.6->1.1.7)

1. 在`列车管理`停靠面板中新增一系列批量操作功能，分别针对当前所选的一组车次进行操作。同时将工具栏`列车`中，原`列车管理`所附菜单中的批量操作（删除所有车次，自动始发终到站适配等）独立成单独的菜单。
2. 【pyETRC既有功能移植】添加`按时刻表重设始发终到站`功能，位于工具栏 `列车`->`批量操作`菜单下。此功能与pyETRC的`重置始发终到站`相同，将列车时刻表的首站、末站强制设为始发终到站。在`列车管理`停靠面板的批量操作菜单下新增同样的功能。
3. 在工具栏以及列车管理停靠面板的批量操作菜单处，新增批量导出列车事件表功能，分别针对所选车次和文件中所有车次操作。导出的事件表列在同一个csv文件中。
4. 新增`*.trf`格式（ETRC列车描述文件）导入功能，允许一次性导入多个文件，每个文件包含一个车次信息。
   `*.trf`文件的具体格式请参见ETRC软件 （版本号3.0及以上）。
5. 修复`标尺合并`功能中，特定情况下无法执行的问题。

### 2022年5月6日 发布1.1.6版本 (R20)

更新日志 (1.1.5->1.1.6)

1. 在`区间车次表`功能中添加正则表达式的支持。细节规则详见弹框提示。
2. 在`标尺综合`功能的选择列车页面，不再显示所有列车，而是仅显示与当前所选线路存在绑定关系的列车，以减少干扰。

### 2022年4月30日 发布1.1.5版本 (R19)

更新日志 (1.1.4->1.1.5)

在`贪心推线`功能的`排图参数`页新增`提取本线既有最小间隔`功能，允许从本线已有的列车间隔中提取最小值作为排图约束。

### 2022年4月24日 发布1.1.4版本 (R18)

更新日志 (1.1.3->1.1.4)

紧急修复自1.1.1版本起，列车时刻表编辑中，编辑新增行时刻导致崩溃的问题。

### 2022年4月24日 发布1.1.3版本 (R17)

更新日志 (1.1.2->1.1.3)

1. 修复车次筛选器初始化状态不正确的问题，此问题导致间隔分析等功能无法正常工作。同时修复上一个版本中`区间对数表`中车次筛选器无效的问题。
2. 在`区间车次表`中，允许输入发站/到站采用垂直线`|`（U+007）作为分隔符，需勾选输入框后的选项。当启用时，以`|`分隔的多个车站以“或”的逻辑关系考虑，即发站（到站）属于所给输入中的任何一个站皆被显示。
   此版本起不建议在任何车站站名中使用`|`符号，以免引起歧义。在车站里程表编辑器的提交时添加检查，如有包含此符号将给出相应的警告。但并不强制要求。

### 2022年4月23日 发布1.1.2版本 (R16)

此版本更新了支持库SARibbon的版本，使用patch更新包的用户请将`SARibbonBar.dll`一并覆盖至原程序目录。

更新日志 (1.1.1->1.1.2)

- 【pyETRC既有功能移植】添加`区间对数表`和`区间车次表`功能，主要用于计算两站之间列车对数，通常用于研究停车列车的通达度。
  请注意此功能只有在前后两站都有时刻表数据时才能查询到，与`断面对数表`功能不同。

### 2022年4月10日 发布1.1.1版本 (R15)

更新日志 (1.1.0_Preview3->1.1.1)

此版本完成贪心推线的反向推线算法。贪心推线功能形式上已经完成，故此版本使用正式版本号。贪心推线功能仍需各种测试，持续接受相关反馈。此外，还有以下更新。

1. 在列车时刻表编辑/列车编辑表格中新增`复制到达时刻为出发时刻`和`复制出发时刻为到达时刻`功能，快捷键分别为<kbd>Alt</kbd>+<kbd>D</kbd>和<kbd>Alt</kbd>+<kbd>Shift</kbd>+<kbd>D</kbd>；亦可在右键菜单调用。
2. 在运行图资源管理器的列车右键菜单新增`编辑时刻表`选项；同时把原`编辑列车`和双击功能，以及`列车管理`功能的双击功能指向（pyETRC风格的）`列车编辑`功能。
3. 新增`从速度计算标尺`功能，位于标尺上下文菜单，支持从给定的运行速度计算近似标尺。

### 2022年4月3日 发布1.1.0_Preview3版本 (R14)

**此版本推荐所有旧版本（含1.0.6及以下版本）更新**

更新日志 (1.1.0_Preview2->1.1.0_Preview3)

1. 【重要错误修正】修正基线编辑后数据不一致的问题。此问题导致特定情况下程序闪退。
2. 修订贪心推线算法的部分细节。

### 2022年3月20日 发布1.1.0_Preview2版本 (R13)

更新日志 (1.1.0_Preview->1.1.0_Preview2)

【测试功能】完成贪心推线功能的正式界面设计。
反向推线（倒推运行线）功能尚未实现，因此目前仅支持锚点站和起始站相同的情况。反推运行线逻辑与正推运行线基本一致，计划待正推运行线功能经过更充分的测试，解决可能存在的问题后，再实现反推运行线功能。

此版本为1.1.0版本的第二预览版，使用请注意及时保存数据。欢迎反馈各种问题，反馈请提供运行图文件、排图参数（可以用贪心推线功能两页的截图）和遇到的问题说明。

### 2022年3月12日 发布1.1.0_Preview版本 (R12)

更新日志 (1.0.6->1.1.0_Preview)

1. 修复中途换向运行线在换向车站出发事件没有被统计的问题。
2. 【测试功能】新增贪心推线功能，按照标尺和所给的约束条件，全自动铺画运行线。此功能位于工具栏`列车`页面`排图`分类下，快捷键为<kbd>Ctrl</kbd>+<kbd>T</kbd>。
   此功能的前端界面尚未完成，目前提供的界面仅提供有限的选项，并仅用于测试算法。目前仅支持在选定线路全程正向铺线。计划待一段时间测试后，再继续完成交互部分以及反向推线算法。
   欢迎对此功能提出反馈。反馈请提供排图基于的运行图文件、自动推线的参数（可截图）以及出现的问题。
   预览版可能不够稳定，特别是测试功能，请注意及时保存数据。

### 2022年2月11日 发布1.0.6版本 (R11)

更新日志 (1.0.5->1.0.6)

【pyETRC既有功能移植】实现运行图对比功能，位于工具栏`列车`页面->`分析`分类下。支持对比两个版本运行图中列车时刻的变化情况。相比原pyETRC的实现，速度大幅提升。

### 2022年2月7日 发布1.0.5版本 (R10)

更新日志 (1.0.4->1.0.5)

1. 在线路数据库中，新增从当前运行图中导入线路的功能。
2. 新增标尺合并功能。
3. 问题修复：
   - 部分场景下，运行图定位出现错误。
   - 基线数据更新后，其标尺数据出现不同步问题。
4. 部分UI优化：
   - 运行图页面的标题栏增加图标，删除`运行图 - `前缀。



### 2022年2月2日 发布1.0.4版本 (R9)

更新日志 (1.0.3->1.0.4)

1. 在`导入车次`(<kbd>Ctrl</kbd>+<kbd>D</kbd>)功能中，更新判定`与本运行图有重叠`的条件。旧版判定条件为车次在本运行图中存在运行线，新版判定条件改为车次时刻表与本运行图中任意线路车站存在交叠，即判定条件放宽，且不再依赖`最大跨越站数`设定项。
   此项更新感谢群友`电排骨`指出问题。
2. 修复：存在标尺的多线路运行图中，更新基线信息可能导致程序崩溃的问题。



### 2021年12月19日 发布1.0.3版本 (R8)

更新日志 （1.0.2->1.0.3）

1. 新增`每小时纵线数`为0至59的限定，以避免不合理设定导致程序崩溃。
2. 对运行图的主要元素（基线/标尺/列车/运行图页面）皆添加`创建副本`的功能，在相应元素的上下文工具栏页面以及资源管理器右键菜单中可用。

### 2021年10月23日 发布1.0.2版本 (R7)

更新日志 （1.0.1->1.0.2）

1. 部分交互优化和小功能：
   - 新增（pyETRC风格的）`列车编辑`停靠面板，包含列车的所有信息及时刻表的编辑。同时在`速览信息`页面中增加入口。新建空白车次时改为弹出本窗口。
   
   - 在列车时刻诊断中，新增按线路和线路车站范围筛选的功能。注意这里的范围筛选简单地基于车站里程比较。
   
     > 关于效率的注记：在多线路的运行图中，选择按线路筛选将只对所选线路的运行线进行诊断，可以显著提升效率；但对线路车站范围的筛选仅是对结果筛选，不会带来效率提升。
   
2. 部分问题修正：

   - 修正一种极端情况下（时刻表相邻两站为不同方向的单向站）运行线铺画算法的错误问题，该问题可能导致时刻诊断等后续功能出错以至崩溃。

### 2021年10月16日 发布1.0.1版本 (R6)

更新日志 (1.0.0->1.0.1)

1. 【逻辑变更】支持各运行图页面/视窗（`DiagramPage`）独立设置运行图显示选项，例如起止时间、显示比例、边距等，以更好适应多线路、多运行图情况的处理。原来`显示(4)`页面中的`显示设置`选项，用于提供新创建的运行图页面的显示设置；同时提供一键将当前选项用于所有页面的功能。
2. 新增快速创建单线路运行图的功能，功能位于运行图资源管理器线路的右键菜单，或线路的上下文工具栏页面。此操作一键创建新的运行图页面，仅包含所选线路，且以所选线路命名。
3. 新增激活（切换到）指定运行图页面的功能，入口位于运行图资源管理器的运行图页面右键菜单，以及运行图上下文工具栏页面。此操作打开指定运行图页面，并将其设置为活动页面。
   同时优化当前运行图的切换条件。
4. 一些交互优化和小功能：
   - 在列车的`速览信息`页面，新增转到所属交路的按钮，将当前列车的交路设置为交路上下文工具栏页面的“当前交路”。
   - 在列车`速览时刻`页面，快速定位到车站操作时，如果只有一条线路、或当前线路只有一个铺画点，跳过选择过程。
   - 新增从运行图页面快速跳转到所包含线路的功能，位于运行图资源管理器的右键菜单，或工具栏运行图上下文页面。
   - 新增`自动始发终到站适配 (放宽)`功能，位于工具栏`列车`->`列车管理`下的菜单中。与原有`自动始发终到站适配`的区别在于，不要求被适配的站是铺画在运行图上的。
   - 在`全局配置选项`中新增系统风格（`style`）的选项。
   - 新增`修改运行图页面`功能，位于`运行图(5)`上下文页面->`编辑`的菜单下。支持重新设置当前运行图页面的名称、备注、线路表。同时重新设计`添加运行图页面`功能的界面。
   - 支持`删除线路`功能的撤销/重做。
   - 新增`关闭当前标签页`功能，快捷键为<kbd>Ctrl</kbd>+<kbd>W</kbd>。
5. 修复一些问题：
   - 修正当车次始发站同时在多条线路上绑定时可能出现的一些错误，以及极端情况下可能导致崩溃的问题。
   - 修复列车时刻表重排功能中，一些情况下对车站进行上移、下移、置顶、置底操作可能导致崩溃的问题。

### 2021年9月30日 发布1.0.0版本 (R5)

此版本为第一个正式版，标志qETRC已经实现了初期计划的全部功能。pyETRC的绝大多数常用功能都已经在qETRC中实现，因此**自此版本开始，建议原pyETRC用户如无特殊需求，可以改使用qETRC进行替代**。如有相关问题、建议，特别是导致程序崩溃的问题，请随相关文件及复现操作反馈。

更新日志 (0.6.0->1.0.0)

1. 【原pyETRC路网管理模块功能集成】基于线路数据库的线网有向图模型，提供路网层面的相关功能。主要包括：

   - 快速径路生成 （<kbd>Ctrl</kbd>+<kbd>J</kbd>）。给出由一组（两个或两个以上）车站（作为路径的`关键点`）描述的路径，在每两个关键点之间，以Dijkstra最短路算法计算路径，生成线路对象并加入到当前运行图中。
   - 经由选择向导 （<kbd>Ctrl</kbd>+<kbd>K</kbd>）。通过最短路、邻站或者邻线三种方式，手动、交互式地确定路径关键点，从而生成线路对象并加入到运行图中。相比快速径路生成，此功能对径路的控制更加精确，但操作步骤较多。
   - 路网邻接表查看。查看当前路网模型中每个车站的基本信息，及每个车站所连接的线路、相邻车站等信息。仅能查看，不能修改数据。

   相比原pyETRC路网管理模块，这部分功能是直接集成在主程序中的，无需另外打开新程序，且对线路、列车数据的管理、共享关系规定得更加严格。此外，本项目重新实现了有向图数据结构，支持“重边”情况 （两个车站之间存在多条线路，线路名称可能不同），解决pyETRC路网模块中由此导致的部分问题。

2. 【pyETRC既有功能移植、拓展】股道分析图功能。原pyETRC入口位于车站时刻表对话框中，本系统改为从线路上下文工具栏页面直接进入。完全支持原pyETRC中的手动铺画、自动铺画以及手动铺画下股道次序管理的功能。
   此外，新支持调整股道名称、顺序功能（调整过程中每个股道内的列车安排不变，可与自动铺画配合使用），并支持将股道数据写入到列车时刻表中。

3. 【pyETRC既有功能移植、拓展】列车时刻表修正功能。完全支持原pyETRC中此功能对列车时刻表的顺序重排（上移、下移、置顶、置底、区间反排）、交换到发时刻等功能，并额外支持修改所有数据功能，可以在勾选相关选项后，修改时刻表中全部信息（站名、到发时刻、股道备注等，但不能增删车站）。
   相比pyETRC的实现，本系统的实现应当更加安全和严格。

4. 【qETRC新增功能】在速览时刻 （<kbd>Ctrl</kbd>+<kbd>I</kbd>）功能中新增对到达时刻或出发时刻进行定位的功能，可用右键菜单调起，或使用快捷键<kbd>Alt</kbd>+<kbd>G</kbd>以及<kbd>Alt</kbd>+<kbd>Shift</kbd>+<kbd>G</kbd>。

5. 【pyETRC既有功能】自动设置所有营业站。

6. 修复一些细节错误。

7. 将默认的线路数据库文件改为`CRPassengerMileage.pyetlib`，内含全国铁路旅客运价里程表内的线路里程数据。感谢@江教授 提供和维护的数据源。



### 2021年9月19日 发布0.6.0版本 (R4)

更新日志 (0.5.1->0.6.0)

1. 【pyETRC既有功能移植】线路数据库功能，以停靠面板形式展示。除新支持撤销/重做外，与pyETRC的功能基本一致。目前的主要操作功能都写在左侧列表树的右键菜单以及窗口的菜单栏中。
   目前只给出了基本功能。较为复杂的移动和批量操作等功能尚未实现。如果这方面需要，可以说明具体形式。
2. 修正导入线路后没有自动绑定到车次（导致没有自动铺画新线运行图）等问题。

目前软件已经接近正式版。
另：今日在B站发布了一个视频，介绍本软件与pyETRC操作逻辑的变化：https://www.bilibili.com/video/BV1334y1X7Wr



### 2021年9月13日 发布0.5.1版本 (R3)

更新日志 (0.5.0->0.5.1)

1. 【pyETRC既有功能移植】时刻表插值（通过站时刻推定）功能，基于标尺，推定车次时刻表中，未给出时刻的车站的通过时刻。操作逻辑与pyETRC基本一致，但基于qETRC的数据结构重新设计了底层算法逻辑，理论上更加安全和严谨。此功能位于工具栏：`列车(3)`-`排图`-`时刻插值`。
2. 修复间隔分析的算法，解决（理论上）特殊情况下（运行线端点站出现类似待避情况）导致待避间隔判定错误的问题。同时在`间隔汇总`窗口设置Flag为`Window`，方便窗口最大化操作。

### 2021年9月10日 发布0.5.0版本 (R2)

更新日志 (0.4.0->0.5.0)

1. 【qETRC新设计功能（模块）】新增车站列车间隔分析的相关功能。位于工具栏的线路上下文菜单，提供`间隔分析`和`间隔汇总`两个入口。前者给出指定车站的详细间隔表，后者一次性统计全线所有车站的最短间隔。在车站事件表中增加间隔分析的入口。
2. 【qETRC新设计功能】新增运行图定位功能。通过输入时刻，选择线路及其车站，或指定里程标，在运行图窗口上标记处相应位置，快捷键为<kbd>Ctrl</kbd>+<kbd>G</kbd>，工具栏位于`线路(3)`->`定位`。
   同时在`列车事件表`、`车站事件表`、`断面事件表`、`线路快照`和`间隔分析`的表格中支持右键快速定位到相应事件。



### 2021年9月5日 发布0.4.0版本 (R1)

从这个版本开始标记Release编号。

自0.3.1版本以来新增的功能：

1. 系统默认运行图设置，以及将当前运行图设置保存为默认设置、将默认设置应用到当前运行图。在`显示`工具栏中。
2. 全局设置选项，在`显示`工具栏中，包括表格行高等设置项。这些设置项自动保存。
3. `速览时刻`功能，是pyETRC中`当前列车时刻表`和`交互式时刻表`功能的合并。调用快捷键为<kbd>Ctrl</kbd>+<kbd>I</kbd>。可以通过`编辑`复选框来决定是否允许修改。如果启用编辑，则修改的时刻立即生效。
4. `速览信息`功能，即pyETRC中的`当前车次信息`功能。调用快捷键仍为<kbd>Ctrl</kbd>+<kbd>Q</kbd>。以上两项的停靠面板默认在运行图右侧显示。
5. 初步完成`列车筛选器`功能，与pyETRC中的列车筛选器基本一致，在全局支持按筛选器来选择要显示的车次，快捷键仍为<kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>L</kbd>。
6. 各种杂项修改。