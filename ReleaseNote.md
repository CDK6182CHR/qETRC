# qETRC列车运行图系统

## 概要

本软件是原pyETRC列车运行图系统的C++重构版本，主要支持列车运行图的绘制、管理、分析等功能。原pyETRC软件原则上不再进行维护。本软件主要在`Windows 10`, `Qt 5.15`, `MSVC 2019`环境下开发和测试。

- 作者：萧迩珀；联系方式：mxy0268@qq.com

- 本系统官方交流群（与pyETRC一致）：865211882

- 本项目开源库：

  - https://github.com/CDK6182CHR/qETRC 
  - https://gitee.com/xep0268/qETRC/

  原则上两边同步更新。

- 原pyETRC系统开源地址：https://github.com/CDK6182CHR/train_graph。

**声明**：

- 本系统按照GPL协议开放源代码。在法律和协议允许范围内，作者保留一切权利。

#### 致谢

- “LGuo的电子运行图”软件（`ETRC`）。本软件最初的开发工作由此而起，并参考该软件较多功能。本软件支持读取和导出其运行图文件。

- [Advanced-Docking-System](https://github.com/githubuser0xFFFF/Qt-Advanced-Docking-System)：提供了任意组织停靠面板的功能。
- [SARibbon](https://github.com/czyt1988/SARibbon): 提供了Ribbon风格工具栏的功能。

## 运行说明

作者提供Win64构建的二进制版本，可以直接运行；也可以从开源库拉取源代码，自行构建。

- win64发行版目前采用MSVC编译器构建，可能需要MSVC的运行时库。
- 源代码构建提示：至少需要Qt5 （小版本号的要求暂不确定，开发用的是5.15），支持C++17标准的编译器。建议采用MSVC 2019。

## 版本更新日志

### 2022年4月3日 发布1.1.0_Preview3版本 (R14)

**此版本推荐所有旧版本（含1.0.6及以下版本）更新**

更新日志 (1.1.0_Preview2->1.1.0_Preview3)

1. 【重要错误修正】修正基线编辑后数据不一致的问题。此问题导致特定情况下程序闪退。
2. 修订贪心推线算法的部分细节。

### 2022年3月20日 发布1.1.0_Preview2版本 (R13)

更新日志 (1.1.0_Preview->1.1.0_Preview2)

【测试功能】完成贪心推线功能的正式界面设计。
反向推线（倒推运行线）功能尚未实现，因此目前仅支持锚点站和起始站相同的情况。反推运行线逻辑与正推运行线基本一致，计划待正推运行线功能经过更充分的测试，解决可能存在的问题后，再实现反推运行线功能。

此版本为1.1.0版本的第二预览版，使用请注意及时保存数据。欢迎反馈各种问题，反馈请提供运行图文件、排图参数（可以用贪心推线功能两页的截图）和遇到的问题说明。

### 2022年3月12日 发布1.1.0_Preview版本 (R12)

更新日志 (1.0.6->1.1.0_Preview)

1. 修复中途换向运行线在换向车站出发事件没有被统计的问题。
2. 【测试功能】新增贪心推线功能，按照标尺和所给的约束条件，全自动铺画运行线。此功能位于工具栏`列车`页面`排图`分类下，快捷键为<kbd>Ctrl</kbd>+<kbd>T</kbd>。
   此功能的前端界面尚未完成，目前提供的界面仅提供有限的选项，并仅用于测试算法。目前仅支持在选定线路全程正向铺线。计划待一段时间测试后，再继续完成交互部分以及反向推线算法。
   欢迎对此功能提出反馈。反馈请提供排图基于的运行图文件、自动推线的参数（可截图）以及出现的问题。
   预览版可能不够稳定，特别是测试功能，请注意及时保存数据。

### 2022年2月11日 发布1.0.6版本 (R11)

更新日志 (1.0.5->1.0.6)

【pyETRC既有功能移植】实现运行图对比功能，位于工具栏`列车`页面->`分析`分类下。支持对比两个版本运行图中列车时刻的变化情况。相比原pyETRC的实现，速度大幅提升。

### 2022年2月7日 发布1.0.5版本 (R10)

更新日志 (1.0.4->1.0.5)

1. 在线路数据库中，新增从当前运行图中导入线路的功能。
2. 新增标尺合并功能。
3. 问题修复：
   - 部分场景下，运行图定位出现错误。
   - 基线数据更新后，其标尺数据出现不同步问题。
4. 部分UI优化：
   - 运行图页面的标题栏增加图标，删除`运行图 - `前缀。



### 2022年2月2日 发布1.0.4版本 (R9)

更新日志 (1.0.3->1.0.4)

1. 在`导入车次`(<kbd>Ctrl</kbd>+<kbd>D</kbd>)功能中，更新判定`与本运行图有重叠`的条件。旧版判定条件为车次在本运行图中存在运行线，新版判定条件改为车次时刻表与本运行图中任意线路车站存在交叠，即判定条件放宽，且不再依赖`最大跨越站数`设定项。
   此项更新感谢群友`电排骨`指出问题。
2. 修复：存在标尺的多线路运行图中，更新基线信息可能导致程序崩溃的问题。



### 2021年12月19日 发布1.0.3版本 (R8)

更新日志 （1.0.2->1.0.3）

1. 新增`每小时纵线数`为0至59的限定，以避免不合理设定导致程序崩溃。
2. 对运行图的主要元素（基线/标尺/列车/运行图页面）皆添加`创建副本`的功能，在相应元素的上下文工具栏页面以及资源管理器右键菜单中可用。

### 2021年10月23日 发布1.0.2版本 (R7)

更新日志 （1.0.1->1.0.2）

1. 部分交互优化和小功能：
   - 新增（pyETRC风格的）`列车编辑`停靠面板，包含列车的所有信息及时刻表的编辑。同时在`速览信息`页面中增加入口。新建空白车次时改为弹出本窗口。
   
   - 在列车时刻诊断中，新增按线路和线路车站范围筛选的功能。注意这里的范围筛选简单地基于车站里程比较。
   
     > 关于效率的注记：在多线路的运行图中，选择按线路筛选将只对所选线路的运行线进行诊断，可以显著提升效率；但对线路车站范围的筛选仅是对结果筛选，不会带来效率提升。
   
2. 部分问题修正：

   - 修正一种极端情况下（时刻表相邻两站为不同方向的单向站）运行线铺画算法的错误问题，该问题可能导致时刻诊断等后续功能出错以至崩溃。

### 2021年10月16日 发布1.0.1版本 (R6)

更新日志 (1.0.0->1.0.1)

1. 【逻辑变更】支持各运行图页面/视窗（`DiagramPage`）独立设置运行图显示选项，例如起止时间、显示比例、边距等，以更好适应多线路、多运行图情况的处理。原来`显示(4)`页面中的`显示设置`选项，用于提供新创建的运行图页面的显示设置；同时提供一键将当前选项用于所有页面的功能。
2. 新增快速创建单线路运行图的功能，功能位于运行图资源管理器线路的右键菜单，或线路的上下文工具栏页面。此操作一键创建新的运行图页面，仅包含所选线路，且以所选线路命名。
3. 新增激活（切换到）指定运行图页面的功能，入口位于运行图资源管理器的运行图页面右键菜单，以及运行图上下文工具栏页面。此操作打开指定运行图页面，并将其设置为活动页面。
   同时优化当前运行图的切换条件。
4. 一些交互优化和小功能：
   - 在列车的`速览信息`页面，新增转到所属交路的按钮，将当前列车的交路设置为交路上下文工具栏页面的“当前交路”。
   - 在列车`速览时刻`页面，快速定位到车站操作时，如果只有一条线路、或当前线路只有一个铺画点，跳过选择过程。
   - 新增从运行图页面快速跳转到所包含线路的功能，位于运行图资源管理器的右键菜单，或工具栏运行图上下文页面。
   - 新增`自动始发终到站适配 (放宽)`功能，位于工具栏`列车`->`列车管理`下的菜单中。与原有`自动始发终到站适配`的区别在于，不要求被适配的站是铺画在运行图上的。
   - 在`全局配置选项`中新增系统风格（`style`）的选项。
   - 新增`修改运行图页面`功能，位于`运行图(5)`上下文页面->`编辑`的菜单下。支持重新设置当前运行图页面的名称、备注、线路表。同时重新设计`添加运行图页面`功能的界面。
   - 支持`删除线路`功能的撤销/重做。
   - 新增`关闭当前标签页`功能，快捷键为<kbd>Ctrl</kbd>+<kbd>W</kbd>。
5. 修复一些问题：
   - 修正当车次始发站同时在多条线路上绑定时可能出现的一些错误，以及极端情况下可能导致崩溃的问题。
   - 修复列车时刻表重排功能中，一些情况下对车站进行上移、下移、置顶、置底操作可能导致崩溃的问题。

### 2021年9月30日 发布1.0.0版本 (R5)

此版本为第一个正式版，标志qETRC已经实现了初期计划的全部功能。pyETRC的绝大多数常用功能都已经在qETRC中实现，因此**自此版本开始，建议原pyETRC用户如无特殊需求，可以改使用qETRC进行替代**。如有相关问题、建议，特别是导致程序崩溃的问题，请随相关文件及复现操作反馈。

更新日志 (0.6.0->1.0.0)

1. 【原pyETRC路网管理模块功能集成】基于线路数据库的线网有向图模型，提供路网层面的相关功能。主要包括：

   - 快速径路生成 （<kbd>Ctrl</kbd>+<kbd>J</kbd>）。给出由一组（两个或两个以上）车站（作为路径的`关键点`）描述的路径，在每两个关键点之间，以Dijkstra最短路算法计算路径，生成线路对象并加入到当前运行图中。
   - 经由选择向导 （<kbd>Ctrl</kbd>+<kbd>K</kbd>）。通过最短路、邻站或者邻线三种方式，手动、交互式地确定路径关键点，从而生成线路对象并加入到运行图中。相比快速径路生成，此功能对径路的控制更加精确，但操作步骤较多。
   - 路网邻接表查看。查看当前路网模型中每个车站的基本信息，及每个车站所连接的线路、相邻车站等信息。仅能查看，不能修改数据。

   相比原pyETRC路网管理模块，这部分功能是直接集成在主程序中的，无需另外打开新程序，且对线路、列车数据的管理、共享关系规定得更加严格。此外，本项目重新实现了有向图数据结构，支持“重边”情况 （两个车站之间存在多条线路，线路名称可能不同），解决pyETRC路网模块中由此导致的部分问题。

2. 【pyETRC既有功能移植、拓展】股道分析图功能。原pyETRC入口位于车站时刻表对话框中，本系统改为从线路上下文工具栏页面直接进入。完全支持原pyETRC中的手动铺画、自动铺画以及手动铺画下股道次序管理的功能。
   此外，新支持调整股道名称、顺序功能（调整过程中每个股道内的列车安排不变，可与自动铺画配合使用），并支持将股道数据写入到列车时刻表中。

3. 【pyETRC既有功能移植、拓展】列车时刻表修正功能。完全支持原pyETRC中此功能对列车时刻表的顺序重排（上移、下移、置顶、置底、区间反排）、交换到发时刻等功能，并额外支持修改所有数据功能，可以在勾选相关选项后，修改时刻表中全部信息（站名、到发时刻、股道备注等，但不能增删车站）。
   相比pyETRC的实现，本系统的实现应当更加安全和严格。

4. 【qETRC新增功能】在速览时刻 （<kbd>Ctrl</kbd>+<kbd>I</kbd>）功能中新增对到达时刻或出发时刻进行定位的功能，可用右键菜单调起，或使用快捷键<kbd>Alt</kbd>+<kbd>G</kbd>以及<kbd>Alt</kbd>+<kbd>Shift</kbd>+<kbd>G</kbd>。

5. 【pyETRC既有功能】自动设置所有营业站。

6. 修复一些细节错误。

7. 将默认的线路数据库文件改为`CRPassengerMileage.pyetlib`，内含全国铁路旅客运价里程表内的线路里程数据。感谢@江教授 提供和维护的数据源。



### 2021年9月19日 发布0.6.0版本 (R4)

更新日志 (0.5.1->0.6.0)

1. 【pyETRC既有功能移植】线路数据库功能，以停靠面板形式展示。除新支持撤销/重做外，与pyETRC的功能基本一致。目前的主要操作功能都写在左侧列表树的右键菜单以及窗口的菜单栏中。
   目前只给出了基本功能。较为复杂的移动和批量操作等功能尚未实现。如果这方面需要，可以说明具体形式。
2. 修正导入线路后没有自动绑定到车次（导致没有自动铺画新线运行图）等问题。

目前软件已经接近正式版。
另：今日在B站发布了一个视频，介绍本软件与pyETRC操作逻辑的变化：https://www.bilibili.com/video/BV1334y1X7Wr



### 2021年9月13日 发布0.5.1版本 (R3)

更新日志 (0.5.0->0.5.1)

1. 【pyETRC既有功能移植】时刻表插值（通过站时刻推定）功能，基于标尺，推定车次时刻表中，未给出时刻的车站的通过时刻。操作逻辑与pyETRC基本一致，但基于qETRC的数据结构重新设计了底层算法逻辑，理论上更加安全和严谨。此功能位于工具栏：`列车(3)`-`排图`-`时刻插值`。
2. 修复间隔分析的算法，解决（理论上）特殊情况下（运行线端点站出现类似待避情况）导致待避间隔判定错误的问题。同时在`间隔汇总`窗口设置Flag为`Window`，方便窗口最大化操作。

### 2021年9月10日 发布0.5.0版本 (R2)

更新日志 (0.4.0->0.5.0)

1. 【qETRC新设计功能（模块）】新增车站列车间隔分析的相关功能。位于工具栏的线路上下文菜单，提供`间隔分析`和`间隔汇总`两个入口。前者给出指定车站的详细间隔表，后者一次性统计全线所有车站的最短间隔。在车站事件表中增加间隔分析的入口。
2. 【qETRC新设计功能】新增运行图定位功能。通过输入时刻，选择线路及其车站，或指定里程标，在运行图窗口上标记处相应位置，快捷键为<kbd>Ctrl</kbd>+<kbd>G</kbd>，工具栏位于`线路(3)`->`定位`。
   同时在`列车事件表`、`车站事件表`、`断面事件表`、`线路快照`和`间隔分析`的表格中支持右键快速定位到相应事件。



### 2021年9月5日 发布0.4.0版本 (R1)

从这个版本开始标记Release编号。

自0.3.1版本以来新增的功能：

1. 系统默认运行图设置，以及将当前运行图设置保存为默认设置、将默认设置应用到当前运行图。在`显示`工具栏中。
2. 全局设置选项，在`显示`工具栏中，包括表格行高等设置项。这些设置项自动保存。
3. `速览时刻`功能，是pyETRC中`当前列车时刻表`和`交互式时刻表`功能的合并。调用快捷键为<kbd>Ctrl</kbd>+<kbd>I</kbd>。可以通过`编辑`复选框来决定是否允许修改。如果启用编辑，则修改的时刻立即生效。
4. `速览信息`功能，即pyETRC中的`当前车次信息`功能。调用快捷键仍为<kbd>Ctrl</kbd>+<kbd>Q</kbd>。以上两项的停靠面板默认在运行图右侧显示。
5. 初步完成`列车筛选器`功能，与pyETRC中的列车筛选器基本一致，在全局支持按筛选器来选择要显示的车次，快捷键仍为<kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>L</kbd>。
6. 各种杂项修改。